# åœ¨çº¿èŠå¤©å®¤çš„æ­å»ºï¼ˆ2025.6.20ï¼‰

### å‰è¨€ï¼š

åœ¨ä¸€ç•ªæ¢ç´¢ä¸aiçš„å¸®åŠ©ä¸‹ï¼Œå®ç°äº†åœ¨çº¿èŠå¤©å®¤çš„åŠŸèƒ½ï¼Œè¿™é‡Œè®°å½•åœ¨æ¡ˆï¼Œé˜²æ­¢å¿˜è®°ã€‚å¦å¤–è¿˜å¾ˆå¤šæŠ€æœ¯å…¶å®è‡ªå·±å¹¶ä¸çŸ¥é“ï¼Œä»£ç ä¹Ÿæ˜¯aiå†™çš„ï¼Œè¿™äº›éƒ½éœ€è¦è‡ªå·±å»å­¦ä¹ ï¼Œå˜æˆè‡ªå·±çš„çŸ¥è¯†ã€‚

---

### è¯¦ç»†æ­¥éª¤ï¼š

é¦–å…ˆåˆ›å»ºå¦‚ä¸‹çš„ç›®å½•ç»“æ„

websocket
â”œâ”€â”€ public
â”‚   â””â”€â”€ index.html
â”œâ”€â”€ server.py
â””â”€â”€ start_server.sh

äºæ˜¯å†æŠŠå„éƒ¨åˆ†çš„å†…å®¹ç»™å‡ºå³å¯ã€‚

1. index.html

   ```html
   <!DOCTYPE html>
   <html lang="zh-CN">
   
   <head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title>ç®€æ˜“èŠå¤©å®¤</title>
       <style>
           * {
               box-sizing: border-box;
               margin: 0;
               padding: 0;
               font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
           }
   
           body {
               background-color: #f5f7fa;
               display: flex;
               flex-direction: column;
               height: 100vh;
               padding: 15px;
               color: #333;
           }
   
           .container {
               max-width: 1000px;
               margin: 0 auto;
               background: white;
               border-radius: 12px;
               box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
               display: flex;
               flex-direction: column;
               height: calc(100vh - 30px);
               overflow: hidden;
           }
   
           .header {
               background: linear-gradient(135deg, #4361ee, #3a0ca3);
               color: white;
               padding: 15px 20px;
               text-align: center;
           }
   
           .header h1 {
               font-weight: 600;
               font-size: 1.8rem;
               margin: 5px 0;
           }
   
           .header .subtitle {
               font-size: 0.9rem;
               opacity: 0.9;
           }
   
           .main-content {
               display: flex;
               flex: 1;
               overflow: hidden;
           }
   
           .chat-area {
               flex: 1;
               padding: 20px;
               overflow-y: auto;
               display: flex;
               flex-direction: column;
               background-color: #f8f9fe;
           }
   
           .message {
               max-width: 80%;
               margin-bottom: 18px;
               padding: 12px 16px;
               border-radius: 18px;
               word-break: break-word;
               line-height: 1.4;
               position: relative;
               box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
               animation: fadeIn 0.3s ease-in-out;
           }
   
           @keyframes fadeIn {
               from {
                   opacity: 0;
                   transform: translateY(10px);
               }
   
               to {
                   opacity: 1;
                   transform: translateY(0);
               }
           }
   
           .received {
               align-self: flex-start;
               background: #ffffff;
               border: 1px solid #e0e0e0;
               border-bottom-left-radius: 5px;
           }
   
           .sent {
               align-self: flex-end;
               background: linear-gradient(135deg, #4361ee, #3a0ca3);
               color: white;
               border-bottom-right-radius: 5px;
           }
   
           .notification {
               align-self: center;
               background: #f0f2f5;
               color: #5c677d;
               border-radius: 20px;
               font-size: 0.85rem;
               padding: 8px 16px;
               margin: 8px 0;
               text-align: center;
           }
   
           .sender-name {
               font-size: 0.8rem;
               font-weight: 600;
               margin-bottom: 4px;
               opacity: 0.8;
           }
   
           .message-content {
               font-size: 1rem;
               line-height: 1.4;
           }
   
           .message-time {
               font-size: 0.7rem;
               text-align: right;
               margin-top: 5px;
               opacity: 0.65;
           }
   
           .input-area {
               display: flex;
               padding: 15px;
               border-top: 1px solid #eee;
               background: white;
           }
   
           #message-input {
               flex: 1;
               padding: 14px 18px;
               border: 1px solid #ddd;
               border-radius: 28px;
               outline: none;
               font-size: 1rem;
               transition: all 0.3s;
               box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
           }
   
           #message-input:focus {
               border-color: #4361ee;
               box-shadow: 0 2px 12px rgba(67, 97, 238, 0.2);
           }
   
           #send-button {
               background: linear-gradient(135deg, #4361ee, #3a0ca3);
               color: white;
               border: none;
               border-radius: 28px;
               padding: 14px 28px;
               margin-left: 12px;
               cursor: pointer;
               font-weight: 600;
               transition: all 0.3s;
               box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
           }
   
           #send-button:hover {
               transform: translateY(-2px);
               box-shadow: 0 6px 14px rgba(67, 97, 238, 0.4);
           }
   
           #send-button:active {
               transform: translateY(0);
           }
   
           #send-button:disabled {
               background: #ccc;
               box-shadow: none;
               cursor: not-allowed;
               transform: none;
           }
   
           .status-bar {
               padding: 10px 15px;
               background: #f8f9fe;
               border-top: 1px solid #eee;
               font-size: 0.85rem;
               color: #5c677d;
               display: flex;
               justify-content: space-between;
           }
   
           .status-item {
               display: flex;
               align-items: center;
           }
   
           .status-dot {
               width: 10px;
               height: 10px;
               border-radius: 50%;
               margin-right: 8px;
           }
   
           .disconnected {
               background-color: #ff6b6b;
           }
   
           .connecting {
               background-color: #ffd166;
               animation: pulse 1.5s infinite;
           }
   
           .connected {
               background-color: #06d6a0;
           }
   
           @keyframes pulse {
               0% {
                   opacity: 0.5;
               }
   
               50% {
                   opacity: 1;
               }
   
               100% {
                   opacity: 0.5;
               }
           }
   
           .config-panel {
               padding: 20px;
               background: #f8f9fe;
               border-left: 1px solid #eee;
               width: 300px;
               overflow-y: auto;
           }
   
           .config-section {
               margin-bottom: 20px;
           }
   
           .config-section h3 {
               margin-bottom: 12px;
               color: #3a0ca3;
               font-size: 1.1rem;
               padding-bottom: 8px;
               border-bottom: 1px solid #eee;
           }
   
           .config-item {
               margin-bottom: 15px;
           }
   
           .config-item label {
               display: block;
               margin-bottom: 6px;
               font-weight: 600;
               font-size: 0.9rem;
               color: #5c677d;
           }
   
           .config-item input {
               width: 100%;
               padding: 12px;
               border: 1px solid #ddd;
               border-radius: 8px;
               font-size: 1rem;
               transition: border-color 0.3s;
           }
   
           .config-item input:focus {
               border-color: #4361ee;
               outline: none;
           }
   
           .info-box {
               background-color: #e8f4ff;
               border-left: 4px solid #4361ee;
               padding: 12px;
               border-radius: 4px;
               font-size: 0.85rem;
               margin-top: 20px;
           }
   
           .info-box h4 {
               margin-top: 0;
               margin-bottom: 8px;
               color: #3a0ca3;
           }
   
           .info-box ul {
               padding-left: 20px;
               margin: 8px 0;
           }
   
           .info-box li {
               margin-bottom: 4px;
           }
   
           .debug-console {
               background-color: #1e1e1e;
               color: #d4d4d4;
               font-family: monospace;
               padding: 12px;
               border-radius: 4px;
               margin-top: 15px;
               max-height: 200px;
               overflow-y: auto;
               font-size: 0.85rem;
               display: none;
           }
   
           .debug-console.show {
               display: block;
           }
   
           .connection-info {
               font-size: 0.8rem;
               color: #777;
               padding: 8px;
               text-align: center;
           }
   
           .toggle-debug {
               background-color: #3a0ca3;
               color: white;
               border: none;
               border-radius: 4px;
               padding: 6px 12px;
               font-size: 0.8rem;
               cursor: pointer;
               float: right;
           }
   
           #debug-console-content {
               white-space: pre-wrap;
               overflow-anchor: none;
           }
   
           .center {
               display: flex;
               justify-content: center;
               align-items: center;
               height: 100%;
           }
       </style>
   </head>
   
   <body>
       <div class="container">
           <div class="header">
               <h1>ç®€æ˜“èŠå¤©å®¤</h1>
               <div class="subtitle">ä½¿ç”¨WebSocketæŠ€æœ¯çš„å®æ—¶èŠå¤©åº”ç”¨</div>
           </div>
   
           <div class="main-content">
               <div class="chat-area" id="chat-area">
                   <div class="center" id="welcome-message">
                       <div>
                           <h2>æ¬¢è¿ä½¿ç”¨èŠå¤©å®¤</h2>
                           <p>æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</p>
                       </div>
                   </div>
               </div>
   
               <div class="config-panel">
                   <button class="toggle-debug" id="toggle-debug">è°ƒè¯•ä¿¡æ¯</button>
   
                   <div class="config-section">
                       <h3>æœåŠ¡å™¨é…ç½®</h3>
   
                       <div class="config-item">
                           <label for="ws-server-input">WebSocketæœåŠ¡å™¨åœ°å€</label>
                           <input type="text" id="ws-server-input" placeholder="ws://IPåœ°å€æˆ–åŸŸå:ç«¯å£"
                               value="ws://8.134.12.212:8765">
                       </div>
   
                       <button id="reconnect-button" class="toggle-debug">é‡æ–°è¿æ¥</button>
                   </div>
   
                   <div class="info-box">
                       <h4>è¿æ¥å¸®åŠ©</h4>
                       <ul>
                           <li>é»˜è®¤WebSocketç«¯å£: 8765</li>
                           <li>æœ¬åœ°è¿æ¥: ws://localhost:8765</li>
                           <li>å±€åŸŸç½‘è¿æ¥: ws://[æœ¬åœ°IP]:8765</li>
                           <li>è¿œç¨‹è¿æ¥: ws://[å…¬ç½‘IP]:8765</li>
                           <li>ç¡®ä¿æœåŠ¡å™¨é˜²ç«å¢™å¼€æ”¾äº†WebSocketç«¯å£</li>
                       </ul>
                   </div>
   
                   <div class="debug-console" id="debug-console">
                       <div id="debug-console-content"></div>
                   </div>
               </div>
           </div>
   
           <div class="input-area">
               <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
               <button id="send-button" disabled>å‘é€</button>
           </div>
   
           <div class="status-bar">
               <div class="status-item">
                   <div class="status-dot disconnected" id="status-dot"></div>
                   <span id="status-text">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</span>
               </div>
               <div class="status-item" id="users-count">
                   <span>åœ¨çº¿äººæ•°: 0</span>
               </div>
           </div>
       </div>
   
       <div class="username-modal" id="username-modal">
           <div class="modal-content">
               <h2>æ¬¢è¿åŠ å…¥èŠå¤©å®¤</h2>
               <p>è¯·è¾“å…¥ç”¨æˆ·å</p>
               <input type="text" id="username-input" maxlength="15" placeholder="è¾“å…¥ç”¨æˆ·å">
               <button id="confirm-username">è¿›å…¥èŠå¤©å®¤</button>
           </div>
       </div>
   
       <script>
           // ===================
           // å¸¸é‡ä¸å…¨å±€å˜é‡
           // ===================
           const DEBUG = true; // å¯ç”¨è°ƒè¯•æ¨¡å¼
           const MAX_RECONNECT_ATTEMPTS = 10;
           const RECONNECT_DELAY = 3000; // 3ç§’
   
           // DOMå…ƒç´ 
           const chatArea = document.getElementById('chat-area');
           const messageInput = document.getElementById('message-input');
           const sendButton = document.getElementById('send-button');
           const usernameModal = document.getElementById('username-modal');
           const usernameInput = document.getElementById('username-input');
           const confirmButton = document.getElementById('confirm-username');
           const statusDot = document.getElementById('status-dot');
           const statusText = document.getElementById('status-text');
           const usersCountElement = document.getElementById('users-count');
           const wsServerInput = document.getElementById('ws-server-input');
           const reconnectButton = document.getElementById('reconnect-button');
           const debugConsole = document.getElementById('debug-console');
           const debugConsoleContent = document.getElementById('debug-console-content');
           const toggleDebugButton = document.getElementById('toggle-debug');
           const welcomeMessage = document.getElementById('welcome-message');
   
           // å…¨å±€å˜é‡
           let username = '';
           let websocket = null;
           let reconnectAttempts = 0;
           let connectionStatus = 'disconnected'; // disconnected, connecting, connected
           let onlineUsers = 0;
   
           // ===================
           // åˆå§‹åŒ–å‡½æ•°
           // ===================
           async function init() {
               // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
               updateConnectionStatus('disconnected');
   
               // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
               addEventListeners();
   
               // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¹‹å‰ä¿å­˜çš„WebSocketåœ°å€
               const savedWsAddress = localStorage.getItem('ws_server_address');
               if (savedWsAddress) {
                   wsServerInput.value = savedWsAddress;
               }
   
               // è¿æ¥WebSocket
               connectWebSocket();
           }
   
           // ===================
           // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
           // ===================
           function addEventListeners() {
               // è¿æ¥äº‹ä»¶
               confirmButton.addEventListener('click', handleConfirmUsername);
               reconnectButton.addEventListener('click', handleReconnect);
   
               // æ¶ˆæ¯äº‹ä»¶
               sendButton.addEventListener('click', sendMessage);
               messageInput.addEventListener('keypress', (e) => {
                   if (e.key === 'Enter') sendMessage();
               });
   
               // è°ƒè¯•äº‹ä»¶
               toggleDebugButton.addEventListener('click', toggleDebugConsole);
   
               // æœåŠ¡å™¨åœ°å€æ›´æ”¹äº‹ä»¶
               wsServerInput.addEventListener('change', () => {
                   localStorage.setItem('ws_server_address', wsServerInput.value);
               });
           }
   
           // ===================
           // WebSocketè¿æ¥ç®¡ç†
           // ===================
           function connectWebSocket() {
               // æ¸…ç†ä¹‹å‰çš„è¿æ¥
               if (websocket) {
                   websocket.close();
                   websocket = null;
               }
   
               // è·å–WebSocketæœåŠ¡å™¨åœ°å€
               let wsAddress = wsServerInput.value.trim();
               if (!wsAddress) {
                   // å°è¯•è‡ªåŠ¨æ„å»ºåœ°å€
                   wsAddress = tryGuessWsAddress();
               }
   
               // æ›´æ–°ç•Œé¢çŠ¶æ€
               updateConnectionStatus('connecting');
               welcomeMessage.style.display = 'flex';
               chatArea.innerHTML = '';
               usersCountElement.innerHTML = '';
   
               // å°è¯•è¿æ¥
               try {
                   logDebug(`å°è¯•è¿æ¥åˆ°: ${wsAddress}`);
                   websocket = new WebSocket(wsAddress);
   
                   websocket.onopen = () => {
                       logDebug("WebSocketè¿æ¥å·²æ‰“å¼€");
                       reconnectAttempts = 0;
                       updateConnectionStatus('connected');
                       welcomeMessage.style.display = 'none';
   
                       // æ˜¾ç¤ºç”¨æˆ·åè¾“å…¥æ¡†
                       usernameModal.style.display = 'flex';
                       usernameInput.focus();
                   };
   
                   websocket.onmessage = (event) => {
                       try {
                           const data = JSON.parse(event.data);
                           handleServerMessage(data);
                           logDebug(`æ”¶åˆ°æ¶ˆæ¯: ${event.data}`);
                       } catch (e) {
                           logDebug(`æ¶ˆæ¯è§£æé”™è¯¯: ${e}`);
                       }
                   };
   
                   websocket.onerror = (error) => {
                       logDebug(`WebSocketé”™è¯¯: ${JSON.stringify(error)}`);
                       updateConnectionStatus('disconnected');
   
                       // å°è¯•é‡æ–°è¿æ¥
                       attemptReconnect();
                   };
   
                   websocket.onclose = () => {
                       logDebug("WebSocketè¿æ¥å·²å…³é—­");
                       updateConnectionStatus('disconnected');
   
                       // å°è¯•é‡æ–°è¿æ¥
                       attemptReconnect();
                   };
   
               } catch (error) {
                   logDebug(`è¿æ¥å¤±è´¥: ${error}`);
                   updateConnectionStatus('disconnected');
                   showError(`è¿æ¥å¤±è´¥: ${error.message || error}`);
   
                   // å°è¯•é‡æ–°è¿æ¥
                   attemptReconnect();
               }
           }
   
           function tryGuessWsAddress() {
               const host = window.location.hæå…‰name;
               let port = 8765; // é»˜è®¤WebSocketç«¯å£
   
               // å¦‚æœHTTPç«¯å£å­˜åœ¨ä¸”ä¸º80ä»¥å¤–çš„å€¼ï¼Œå°è¯•å¢åŠ 1ä½œä¸ºWebSocketç«¯å£
               if (window.location.port && window.location.port !== "80") {
                   port = parseInt(window.location.port) + 1;
               }
   
               return `ws://${host}:${port}`;
           }
   
           function attemptReconnect() {
               if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                   reconnectAttempts++;
                   const delay = RECONNECT_DELAY * Math.min(reconnectAttempts, 5);
   
                   logDebug(`å°è¯•é‡æ–°è¿æ¥ (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})ï¼Œç­‰å¾…${delay / 1000}ç§’...`);
                   updateConnectionStatus('connecting', `å°è¯•é‡æ–°è¿æ¥ (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
   
                   setTimeout(() => {
                       connectWebSocket();
                   }, delay);
               } else {
                   updateConnectionStatus('disconnected', "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥é…ç½®");
               }
           }
   
           function handleReconnect() {
               reconnectAttempts = 0;
               localStorage.setItem('ws_server_address', wsServerInput.value);
               connectWebSocket();
           }
   
           // ===================
           // ç”¨æˆ·èº«ä»½å¤„ç†
           // ===================
           function handleConfirmUsername() {
               const name = usernameInput.value.trim();
               if (name) {
                   username = name;
                   usernameModal.style.display = 'none';
   
                   if (websocket && websocket.readyState === WebSocket.OPEN) {
                       // å‘é€ç”¨æˆ·ååˆ°æœåŠ¡å™¨ - ç¡®ä¿æ ¼å¼æ­£ç¡®
                       websocket.send(JSON.stringify({
                           "username": username
                       }));
   
                       // å¯ç”¨è¾“å…¥æ¡†
                       messageInput.disabled = false;
                       messageInput.focus();
                       sendButton.disabled = false;
                   }
               } else {
                   alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
               }
           }
   
           // ===================
           // æ¶ˆæ¯å¤„ç†
           // ===================
           function handleServerMessage(data) {
               switch (data.type) {
                   case 'message':
                       // åªæ˜¾ç¤ºåˆ«äººå‘é€çš„æ¶ˆæ¯
                       if (data.username !== username) {
                           addMessage(data.username, data.content, data.timestamp, true);
                       } else {
                           logDebug("å¿½ç•¥è‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼ˆç”±æœåŠ¡å™¨å¹¿æ’­ï¼‰");
                       }
                       break;
   
                   case 'notification':
                       addNotification(data.content);
                       if (data.content.includes("åœ¨çº¿äººæ•°")) {
                           updateUsersCount(data.content);
                       }
                       break;
   
                   default:
                       logDebug(`æœªçŸ¥çš„æ¶ˆæ¯ç±»å‹: ${data.type}`);
               }
           }
   
           function sendMessage() {
               const content = messageInput.value.trim();
               if (content && websocket && websocket.readyState === WebSocket.OPEN) {
                   try {
                       // è·å–å½“å‰æ—¶é—´æˆ³
                       const now = new Date();
                       const hours = String(now.getHours()).padStart(2, '0');
                       const minutes = String(now.getMinutes()).padStart(2, '0');
                       const seconds = String(now.getSeconds()).padStart(2, '0');
                       const timestamp = `${hours}:${minutes}:${seconds}`;
   
                       // åœ¨æœ¬åœ°æ˜¾ç¤ºè‡ªå·±å‘é€çš„æ¶ˆæ¯
                       addMessage(username, content, timestamp, false);
                       logDebug(`æœ¬åœ°æ˜¾ç¤ºæ¶ˆæ¯: ${content}`);
   
                       // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
                       websocket.send(JSON.stringify({
                           "content": content
                       }));
   
                       // æ¸…ç©ºè¾“å…¥æ¡†
                       messageInput.value = '';
                       logDebug(`å‘é€æ¶ˆæ¯: ${content}`);
                   } catch (e) {
                       logDebug(`å‘é€æ¶ˆæ¯å¤±è´¥: ${e}`);
                   }
               }
           }
   
           // ===================
           // UIæ›´æ–°å‡½æ•°
           // ===================
           function addMessage(sender, content, timestamp, isReceived = true) {
               // ç¡®ä¿èŠå¤©åŒºåŸŸå¯è§
               if (welcomeMessage.style.display === 'flex') {
                   welcomeMessage.style.display = 'none';
               }
   
               const messageDiv = document.createElement('div');
               messageDiv.className = `message ${isReceived ? 'received' : 'sent'}`;
   
               messageDiv.innerHTML = `
                   <div class="sender-name">${sender}</div>
                   <div class="message-content">${content}</div>
                   <div class="message-time">${timestamp}</div>
               `;
   
               chatArea.appendChild(messageDiv);
   
               // æ»šåŠ¨åˆ°åº•éƒ¨
               chatArea.scrollTop = chatArea.scrollHeight;
   
               logDebug(`æ·»åŠ æ¶ˆæ¯: ${sender} - ${content.substring(0, 20)}`);
           }
   
           function addNotification(content) {
               const notifDiv = document.createElement('div');
               notifDiv.className = 'message notification';
               notifDiv.textContent = content;
               chatArea.appendChild(notifDiv);
               chatArea.scrollTop = chatArea.scrollHeight;
   
               // æå–åœ¨çº¿äººæ•°
               const countMatch = content.match(/(\d+)\s*ä¸ª/);
               if (countMatch) {
                   onlineUsers = parseInt(countMatch[1]);
                   usersCountElement.innerHTML = `<span>åœ¨çº¿äººæ•°: ${onlineUsers}</span>`;
               }
           }
   
           function updateUsersCount(text) {
               usersCountElement.innerHTML = `<span>${text}</span>`;
           }
   
           function updateConnectionStatus(status, message) {
               connectionStatus = status;
               statusDot.className = `status-dot ${status}`;
   
               const statusMessages = {
                   disconnected: message || "è¿æ¥å·²æ–­å¼€",
                   connecting: message || "æ­£åœ¨è¿æ¥æœåŠ¡å™¨...",
                   connected: message || "å·²è¿æ¥"
               };
   
               statusText.textContent = statusMessages[status];
           }
   
           function showError(message) {
               const errorDiv = document.createElement('div');
               errorDiv.className = 'message notification';
               errorDiv.style.backgroundColor = '#ff6b6b40';
               errorDiv.textContent = `é”™è¯¯: ${message}`;
               chatArea.appendChild(errorDiv);
           }
   
           // ===================
           // è°ƒè¯•åŠŸèƒ½
           // ===================
           function logDebug(message) {
               if (DEBUG) {
                   const timestamp = new Date().toISOString().substring(11, 23);
                   const logEntry = `${timestamp}: ${message}\n`;
                   debugConsoleContent.textContent += logEntry;
                   debugConsoleContent.scrollTop = debugConsoleContent.scrollHeight;
   
                   // å§‹ç»ˆæ˜¾ç¤ºè°ƒè¯•é¢æ¿
                   debugConsole.classList.add('show');
               }
           }
   
           function toggleDebugConsole() {
               debugConsole.classList.toggle('show');
           }
   
           // ===================
           // åˆå§‹åŒ–åº”ç”¨
           // ===================
           document.addEventListener('DOMContentLoaded', init);
       </script>
   </body>
   
   </html>
   
   ```

2. server.py

   ```python
   import asyncio
   import websockets
   import json
   from datetime import datetime
   import argparse
   import os
   import socket
   import logging
   from http.server import ThreadingHTTPServer, SimpleHTTPRequestHandler
   import threading
   import webbrowser
   import traceback
   from collections import namedtuple
   
   # è®¾ç½®è¯¦ç»†æ—¥å¿—
   logging.basicConfig(
       level=logging.INFO,
       format='%(asctime)s - %(levelname)s - %(message)s',
       handlers=[logging.StreamHandler()]
   )
   logger = logging.getLogger(__name__)
   
   # ä½¿ç”¨å‘½åå…ƒç»„åˆ›å»ºå¯å“ˆå¸Œçš„å®¢æˆ·ç«¯æ•°æ®ç»“æ„
   ClientData = namedtuple('ClientData', ['ws', 'username'])
   connected_clients = set()
   
   class CustomHTTPRequestHandler(SimpleHTTPRequestHandler):
       """è‡ªå®šä¹‰HTTPè¯·æ±‚å¤„ç†å™¨"""
       def __init__(self, *args, **kwargs):
           super().__init__(*args, directory='public', **kwargs)
       
       def guess_type(self, path):
           """é‡å†™MIMEç±»å‹çŒœæµ‹æ–¹æ³•"""
           if path.endswith(".js"):
               return "application/javascript"
           if path.endswith(".css"):
               return "text/css"
           return super().guess_type(path)
       
       def log_message(self, format, *args):
           """é‡å†™æ—¥å¿—æ–¹æ³•ä»¥å‡å°‘è¾“å‡º"""
           logger.info(f"HTTPè¯·æ±‚: {self.address_string()} - {format % args}")
   
   async def handle_client(websocket):
       """å¤„ç†å®¢æˆ·ç«¯è¿æ¥ - ç§»é™¤äº†'path'å‚æ•°"""
       client_ip = websocket.remote_address[0]
       logger.info(f"æ–°è¿æ¥æ¥è‡ª: {client_ip}")
       
       # ä½¿ç”¨å‘½åå…ƒç»„å­˜å‚¨å®¢æˆ·ç«¯æ•°æ®
       client_data = None
       username = "åŒ¿åç”¨æˆ·"  # åˆå§‹ç”¨æˆ·å
       
       try:
           # æ·»åŠ è¿æ¥è¶…æ—¶å¤„ç†
           try:
               # ç­‰å¾…ç”¨æˆ·åæ¶ˆæ¯ï¼ˆæœ€å¤š10ç§’ï¼‰
               username_msg = await asyncio.wait_for(websocket.recv(), timeout=10.0)
               username_data = json.loads(username_msg)
               
               # ç¡®ä¿æ¶ˆæ¯ä¸­æœ‰usernameå­—æ®µ
               if "username" not in username_data:
                   await websocket.send(json.dumps({
                       "type": "error",
                       "message": "ç¼ºå°‘ç”¨æˆ·åå­—æ®µï¼Œè¯·é‡æ–°è¿æ¥"
                   }))
                   logger.error("å®¢æˆ·ç«¯æœªæä¾›ç”¨æˆ·åå­—æ®µ")
                   return
                   
               username = username_data["username"][:15]  # é™åˆ¶ç”¨æˆ·åé•¿åº¦
           except asyncio.TimeoutError:
               await websocket.send(json.dumps({
                   "type": "error",
                   "message": "è¿æ¥è¶…æ—¶ï¼Œè¯·é‡æ–°è¿æ¥"
               }))
               logger.error("ç­‰å¾…ç”¨æˆ·åæ¶ˆæ¯è¶…æ—¶")
               return
           except json.JSONDecodeError:
               await websocket.send(json.dumps({
                   "type": "error",
                   "message": "ç”¨æˆ·åæ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°è¿æ¥"
               }))
               logger.error("ç”¨æˆ·åæ¶ˆæ¯JSONè§£æé”™è¯¯")
               return
           
           logger.info(f"ç”¨æˆ·è®¤è¯æˆåŠŸ: {username} ({client_ip})")
           
           # åˆ›å»ºå¯å“ˆå¸Œçš„å®¢æˆ·ç«¯æ•°æ®ç»“æ„
           client_data = ClientData(ws=websocket, username=username)
           connected_clients.add(client_data)
           
           # é€šçŸ¥æ‰€æœ‰äººæœ‰æ–°ç”¨æˆ·åŠ å…¥
           join_msg = json.dumps({
               "type": "notification",
               "content": f"{username} åŠ å…¥äº†èŠå¤©å®¤"
           })
           await broadcast(join_msg, sender=websocket)
           
           # å‘é€æ¬¢è¿æ¶ˆæ¯
           welcome_msg = json.dumps({
               "type": "message",
               "username": "ç³»ç»Ÿ",
               "content": f"æ¬¢è¿ {username} åŠ å…¥èŠå¤©å®¤ï¼ç›®å‰åœ¨çº¿äººæ•°: {len(connected_clients)}",
               "timestamp": get_timestamp()
           })
           await websocket.send(welcome_msg)
           
           # æŒç»­æ¥æ”¶æ¶ˆæ¯
           while True:
               try:
                   # è®¾ç½®æ¥æ”¶è¶…æ—¶ï¼ˆ300ç§’ = 5åˆ†é’Ÿï¼‰
                   message = await asyncio.wait_for(websocket.recv(), timeout=300.0)
                   if message:
                       try:
                           # è§£ææ¶ˆæ¯å¹¶ç¡®ä¿æœ‰contentå­—æ®µ
                           msg_data = json.loads(message)
                           
                           if "content" not in msg_data:
                               await websocket.send(json.dumps({
                                   "type": "error",
                                   "message": "æ¶ˆæ¯æ ¼å¼é”™è¯¯ï¼Œç¼ºå°‘contentå­—æ®µ"
                               }))
                               continue
                           
                           # è®°å½•æ¥æ”¶åˆ°çš„æ¶ˆæ¯
                           log_message = msg_data["content"]
                           if len(log_message) > 50:
                               log_message = log_message[:47] + "..."
                           logger.info(f"æ¥è‡ª {username} çš„æ¶ˆæ¯: {log_message}")
                           
                           # åˆ›å»ºå¹¿æ’­æ¶ˆæ¯
                           broadcast_msg = json.dumps({
                               "type": "message",
                               "username": username,
                               "content": msg_data["content"],
                               "timestamp": get_timestamp()
                           })
                           await broadcast(broadcast_msg, sender=websocket)
                       except json.JSONDecodeError:
                           await websocket.send(json.dumps({
                               "type": "error",
                               "message": "æ— æ³•è§£æJSONæ ¼å¼æ¶ˆæ¯"
                           }))
                       except Exception as e:
                           logger.error(f"å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: {e}")
                           traceback.print_exc()
               except asyncio.TimeoutError:
                   # è¶…æ—¶åå‘é€pingä¿æŒè¿æ¥
                   try:
                       await websocket.ping()
                   except:
                       break  # å¦‚æœpingå¤±è´¥ï¼Œæ–­å¼€è¿æ¥
               except (websockets.ConnectionClosed, ConnectionResetError, BrokenPipeError) as e:
                   # ä¸“é—¨å¤„ç†è¿æ¥å…³é—­å¼‚å¸¸
                   if isinstance(e, websockets.ConnectionClosed):
                       logger.info(f"è¿æ¥å·²å…³é—­ ({username}): ä»£ç ={e.code}, åŸå› ={e.reason}")
                   else:
                       logger.info(f"è¿æ¥é‡ç½®æˆ–å…³é—­: {username}")
                   break
               except Exception as e:
                   logger.error(f"æ¥æ”¶æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯: {e}")
                   traceback.print_exc()
                   break
                   
       except (websockets.ConnectionClosed, ConnectionResetError, BrokenPipeError) as e:
           code = e.code if isinstance(e, websockets.ConnectionClosed) else "N/A"
           reason = e.reason if isinstance(e, websockets.ConnectionClosed) else "è¿æ¥é‡ç½®"
           logger.info(f"è¿æ¥å·²å…³é—­ ({username}): ä»£ç ={code}, åŸå› ={reason}")
       except Exception as e:
           logger.error(f"è¿æ¥é”™è¯¯: {e}")
           traceback.print_exc()
       finally:
           # å®‰å…¨åœ°ç§»é™¤å®¢æˆ·ç«¯
           if client_data and client_data in connected_clients:
               connected_clients.discard(client_data)
               # é€šçŸ¥å…¶ä»–äººç”¨æˆ·ç¦»å¼€
               try:
                   if username != "åŒ¿åç”¨æˆ·":
                       logger.info(f"ç”¨æˆ·ç¦»å¼€: {username}")
                       leave_msg = json.dumps({
                           "type": "notification",
                           "content": f"{username} ç¦»å¼€äº†èŠå¤©å®¤"
                       })
                       await broadcast(leave_msg)
               except:
                   logger.warning("å‘é€ç¦»å¼€é€šçŸ¥å¤±è´¥")
   
   async def broadcast(message, sender=None):
       """å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯ï¼ˆé™¤äº†å‘é€è€…ï¼‰"""
       if not connected_clients:
           return
       
       tasks = []
       clients_to_remove = []
       
       for client in list(connected_clients):  # ä½¿ç”¨å‰¯æœ¬è¿›è¡Œè¿­ä»£
           try:
               # è·³è¿‡å‘é€è€…
               if client.ws == sender:
                   continue
                   
               # å‘é€æ¶ˆæ¯
               tasks.append(client.ws.send(message))
           except (websockets.ConnectionClosed, ConnectionResetError, BrokenPipeError):
               # å¦‚æœè¿æ¥å·²å…³é—­ï¼Œæ ‡è®°ä¸ºéœ€è¦ç§»é™¤
               clients_to_remove.append(client)
           except Exception as e:
               logger.error(f"å¹¿æ’­æ¶ˆæ¯æ—¶å‡ºé”™: {e}")
               clients_to_remove.append(client)
       
       # ç§»é™¤å¤±æ•ˆçš„å®¢æˆ·ç«¯
       for client in clients_to_remove:
           if client in connected_clients:
               connected_clients.discard(client)
       
       # å¼‚æ­¥å‘é€æ‰€æœ‰æ¶ˆæ¯
       if tasks:
           try:
               await asyncio.gather(*tasks)
           except Exception as e:
               logger.error(f"å¹¿æ’­æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯: {e}")
   
   def get_timestamp():
       """è·å–æ ¼å¼åŒ–æ—¶é—´"""
       return datetime.now().strftime("%H:%M:%S")
   
   def get_local_ip():
       """è·å–æœ¬åœ°IPåœ°å€"""
       try:
           s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
           s.connect(("8.8.8.8", 80))
           ip = s.getsockname()[0]
           s.close()
           return ip
       except:
           return "localhost"
   
   def start_http_server(port, host=''):
       """å¯åŠ¨HTTPæœåŠ¡å™¨"""
       logger.info(f"å¯åŠ¨HTTPæœåŠ¡å™¨: {host}:{port}")
       
       class ThreadedHTTPServer(ThreadingHTTPServer):
           daemon_threads = True
           
       server_address = (host, port)
       httpd = ThreadedHTTPServer(server_address, CustomHTTPRequestHandler)
       
       def run_server():
           try:
               logger.info(f"HTTPæœåŠ¡å™¨åœ¨ç«¯å£ {port} ä¸Šè¿è¡Œ")
               httpd.serve_forever()
           except Exception as e:
               logger.error(f"HTTPæœåŠ¡å™¨é”™è¯¯: {e}")
           finally:
               httpd.server_close()
               logger.info("HTTPæœåŠ¡å™¨å·²å…³é—­")
       
       http_thread = threading.Thread(target=run_server)
       http_thread.daemon = True
       http_thread.start()
       
       return httpd
   
   async def start_websocket_server(host, port):
       """å¯åŠ¨WebSocketæœåŠ¡å™¨"""
       logger.info(f"å¯åŠ¨WebSocketæœåŠ¡å™¨: {host}:{port}")
       
       # ä½¿ç”¨æ›´å¼ºå¤§çš„é”™è¯¯å¤„ç†
       server = await websockets.serve(
           handle_client,
           host, 
           port,
           ping_interval=20,   # æ¯20ç§’å‘é€ping
           ping_timeout=120,    # ç­‰å¾…pongå›å¤120ç§’
           close_timeout=10,    # å…³é—­è¿æ¥è¶…æ—¶æ—¶é—´
           max_size=10 * 1024 * 1024,  # 10MBæœ€å¤§æ¶ˆæ¯å¤§å°
           max_queue=1000,      # æ›´å¤§çš„æ¶ˆæ¯é˜Ÿåˆ—
       )
       
       # è®°å½•æœåŠ¡å™¨å¯åŠ¨è¯¦æƒ…
       logger.info(f"WebSocketæœåŠ¡å™¨åœ¨ ws://{host}:{port} ä¸Šè¿è¡Œ")
       logger.info(f"pingé—´éš”: 20ç§’, pingè¶…æ—¶: 120ç§’")
       
       return server
   
   def display_connection_info(http_port, ws_port):
       """æ˜¾ç¤ºè¿æ¥ä¿¡æ¯"""
       local_ip = get_local_ip()
       print("\n" + "="*60)
       print(f"ğŸ‰ èŠå¤©æœåŠ¡å™¨å·²æˆåŠŸå¯åŠ¨!")
       print("="*60)
       print(f"ğŸŒ HTTPæœåŠ¡å™¨åœ°å€:")
       print(f"   http://localhost:{http_port}   (æœ¬æœºè®¿é—®)")
       if local_ip != "localhost":
           print(f"   http://{local_ip}:{http_port} (å±€åŸŸç½‘å†…å…¶ä»–è®¾å¤‡è®¿é—®)")
       
       print(f"\nğŸ“¡ WebSocketæœåŠ¡å™¨åœ°å€:")
       print(f"   ws://localhost:{ws_port}   (æœ¬æœºè®¿é—®)")
       if local_ip != "localhost":
           print(f"   ws://{local_ip}:{ws_port} (å±€åŸŸç½‘å†…å…¶ä»–è®¾å¤‡è®¿é—®)")
       
       print("\nğŸ’¡ æ•…éšœæ’é™¤æç¤º:")
       print("1. å¦‚æœæ— æ³•è¿æ¥ï¼Œè¯·ç¡®ä¿é˜²ç«å¢™å…è®¸ç«¯å£: HTTP ({}) å’Œ WebSocket ({})".format(http_port, ws_port))
       print("2. å¯¹äºäº‘æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥å®‰å…¨ç»„/é˜²ç«å¢™è§„åˆ™")
       print("3. å¦‚æœæœ‰é˜²ç—…æ¯’è½¯ä»¶ï¼Œè¯·å°è¯•æš‚æ—¶ç¦ç”¨")
       print("4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ (æŒ‰F12)")
       print("5. ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®š")
       print("="*60 + "\n")
   
   async def main():
       parser = argparse.ArgumentParser(description='WebSocketèŠå¤©å®¤æœåŠ¡å™¨')
       parser.add_argument('--http-host', default='', help='HTTPæœåŠ¡å™¨ç»‘å®šåœ°å€')
       parser.add_argument('--http-port', type=int, default=8080, help='HTTPæœåŠ¡å™¨ç«¯å£')
       parser.add_argument('--ws-host', default='0.0.0.0', help='WebSocketæœåŠ¡å™¨ç»‘å®šåœ°å€')
       parser.add_argument('--ws-port', type=int, default=8765, help='WebSocketæœåŠ¡å™¨ç«¯å£')
       parser.add_argument('--no-browser', action='store_true', help='ä¸è¦è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨')
       parser.add_argument('--debug', action='store_true', help='å¯ç”¨è°ƒè¯•æ¨¡å¼')
       args = parser.parse_args()
       
       if args.debug:
           logging.getLogger().setLevel(logging.DEBUG)
           logger.info("è°ƒè¯•æ¨¡å¼å·²å¯ç”¨")
       
       # åˆ›å»ºpublicç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
       if not os.path.exists('public'):
           os.makedirs('public')
           logger.info("å·²åˆ›å»º public ç›®å½•")
       
       # ç¡®ä¿æœ‰é»˜è®¤çš„index.htmlæ–‡ä»¶
       default_html_path = os.path.join('public', 'index.html')
       if not os.path.exists(default_html_path):
           logger.warning("æœªæ‰¾åˆ°index.htmlæ–‡ä»¶ï¼Œåˆ›å»ºç®€å•ç¤ºä¾‹")
           with open(default_html_path, 'w') as f:
               f.write("""<!DOCTYPE html>
   <html>
   <head><title>èŠå¤©å®¤</title></head>
   <body>
       <h1>èŠå¤©å®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ</h1>
       <p>è¯·åˆ›å»ºindex.htmlæ–‡ä»¶æ”¾ç½®åœ¨publicç›®å½•</p>
   </body>
   </html>""")
           logger.info("å·²åˆ›å»ºé»˜è®¤index.htmlæ–‡ä»¶")
       
       # å¯åŠ¨HTTPæœåŠ¡å™¨
       logger.info("å¯åŠ¨HTTPæœåŠ¡å™¨...")
       http_server = start_http_server(args.http_port, args.http_host)
       
       # å¯åŠ¨WebSocketæœåŠ¡å™¨
       logger.info("å¯åŠ¨WebSocketæœåŠ¡å™¨...")
       ws_server = await start_websocket_server(args.ws_host, args.ws_port)
       
       # æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
       display_connection_info(args.http_port, args.ws_port)
       
       # åœ¨æµè§ˆå™¨ä¸­è‡ªåŠ¨æ‰“å¼€ï¼ˆå¯é€‰ï¼‰
       if not args.no_browser:
           try:
               url = f"http://localhost:{args.http_port}"
               logger.info(f"åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€: {url}")
               webbrowser.open(url)
           except Exception as e:
               logger.warning(f"æ— æ³•è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨: {e}")
       
       # ä¿æŒæœåŠ¡å™¨è¿è¡Œ
       logger.info("æœåŠ¡å™¨å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œ")
       try:
           # è®°å½•è¿è¡ŒçŠ¶æ€
           logger.info("ä½¿ç”¨ Ctrl+C åœæ­¢æœåŠ¡å™¨")
           await asyncio.Future()  # æ°¸ä¹…è¿è¡Œ
       except KeyboardInterrupt:
           logger.info("\næœåŠ¡å™¨æ­£åœ¨å…³é—­...")
       finally:
           # å…³é—­WebSocketæœåŠ¡å™¨
           logger.info("å…³é—­WebSocketæœåŠ¡å™¨...")
           ws_server.close()
           await ws_server.wait_closed()
           logger.info("WebSocketæœåŠ¡å™¨å·²å…³é—­")
           
           # å…³é—­HTTPæœåŠ¡å™¨
           logger.info("å…³é—­HTTPæœåŠ¡å™¨...")
           http_server.shutdown()
           logger.info("HTTPæœåŠ¡å™¨å·²å…³é—­")
   
   if __name__ == "__main__":
       # åœ¨Windowsä¸Šè®¾ç½®æ›´å¥½çš„äº‹ä»¶å¾ªç¯ç­–ç•¥
       if os.name == 'nt':
           asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
       
       # æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
       try:
           asyncio.run(main())
       except Exception as e:
           logger.error(f"æœåŠ¡å™¨å¯åŠ¨å¤±è´¥: {e}")
           traceback.print_exc()
           print("\nè¯·æ£€æŸ¥ç«¯å£æ˜¯å¦å¯ç”¨ï¼Œæˆ–å°è¯•ä½¿ç”¨ --http-port å’Œ --ws-port æŒ‡å®šä¸åŒç«¯å£")
   
   ```

3. start_server.sh

   ```shell
   #! /bin/bash
   python3 server.py --http-port 8001
   ```

ç„¶åæˆ‘ä»¬åªéœ€è¦åœ¨ç»ˆç«¯è¿è¡Œï¼š

```shell
chmod +x start_server.sh
./start_server.sh
```

äºæ˜¯æˆ‘ä»¬çš„æœåŠ¡å°±æˆåŠŸå¯åŠ¨äº†ã€‚
